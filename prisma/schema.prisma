// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// RSS Feed Sources
model Feed {
    id             String    @id @default(cuid())
    type           FeedType  // RSS or NOSTR
    url            String?   // RSS feed URL
    npub           String?   // Nostr npub for NIP-23 subscriptions
    title          String
    description    String?
    isActive       Boolean   @default(true)
    lastFetchedAt  DateTime?
    createdAt      DateTime  @default(now())
    updatedAt      DateTime  @updatedAt
    
    // Relations
    subscriptions Subscription[]
    items         FeedItem[]
    
    @@unique([type, url])
    @@unique([type, npub])
    @@index([type, isActive])
}

model FeedItem {
    id          String   @id @default(cuid())
    feedId      String
    title       String
    content     String   @db.Text
    url         String?
    author      String?
    publishedAt DateTime
    guid        String?  // RSS guid or Nostr event id (optional)
    videoId     String?  // YouTube video ID or Rumble video ID
    embedUrl    String?  // Full embed URL for video
    thumbnail   String?  // Video thumbnail URL
    createdAt   DateTime @default(now())
    
    // Relations
    feed      Feed       @relation(fields: [feedId], references: [id], onDelete: Cascade)
    readItems ReadItem[]
    favorites Favorite[]
    
    @@unique([feedId, guid])
    @@index([feedId, publishedAt])
}

model Subscription {
    id         String   @id @default(cuid())
    userPubkey String   // Nostr pubkey
    feedId     String
    tags       String[] @default([]) // User-defined tags/categories
    categoryId String?  // Optional: Link to a category
    createdAt  DateTime @default(now())
    
    // Relations  
    feed     Feed      @relation(fields: [feedId], references: [id], onDelete: Cascade)
    category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    
    @@unique([userPubkey, feedId])
    @@index([userPubkey])
    @@index([userPubkey, tags])
    @@index([userPubkey, categoryId])
}

// User-defined categories for organizing feeds
model Category {
    id         String   @id @default(cuid())
    userPubkey String   // Nostr pubkey - categories are per-user
    name       String   // Category name
    color      String?  // Optional hex color for display
    icon       String?  // Optional emoji icon
    sortOrder  Int      @default(0) // For custom ordering
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    // Relations
    subscriptions Subscription[]
    
    @@unique([userPubkey, name])
    @@index([userPubkey])
    @@index([userPubkey, sortOrder])
}

// User preferences including organization mode
model UserPreference {
    id              String   @id @default(cuid())
    userPubkey      String   @unique // Nostr pubkey
    organizationMode String  @default("tags") // "tags" or "categories"
    nostrRelays     String[] @default([])
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    
    @@index([userPubkey])
}

model ReadItem {
    id         String   @id @default(cuid())
    userPubkey String   // Nostr pubkey  
    itemId     String
    readAt     DateTime @default(now())
    
    // Relations
    feedItem FeedItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
    
    @@unique([userPubkey, itemId])
    @@index([userPubkey])
}

model Favorite {
    id         String   @id @default(cuid())
    userPubkey String   // Nostr pubkey
    itemId     String
    createdAt  DateTime @default(now())
    
    // Relations
    feedItem FeedItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
    
    @@unique([userPubkey, itemId])
    @@index([userPubkey])
    @@index([userPubkey, createdAt])
}

model NostrRelay {
    id        Int      @id @default(autoincrement())
    url       String   @unique
    name      String?
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Guide Directory - Public catalog of Nostr feeds
model GuideFeed {
    id                String   @id @default(cuid())
    npub              String   @unique
    displayName       String   // Author's display name
    about             String?  @db.Text // Author's bio
    picture           String?  // Profile picture URL
    tags              String[] @default([]) // Topic tags for categorization
    submittedBy       String?  // Nostr pubkey of who submitted it
    lastPublishedAt   DateTime? // Date of most recent post
    postCount         Int      @default(0) // Number of long-form posts
    subscriberCount   Int      @default(0) // How many people subscribed via guide
    isActive          Boolean  @default(true)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    
    @@index([tags])
    @@index([lastPublishedAt])
    @@index([subscriberCount])
}

// User Subscriptions - Track paid subscriptions for feed reader access
model UserSubscription {
    id                String   @id @default(cuid())
    userPubkey        String   @unique // Nostr pubkey
    status            SubscriptionStatus @default(TRIAL)
    trialEndsAt       DateTime // When the 7 day trial ends
    subscriptionEndsAt DateTime? // When current paid period ends (null if trial/cancelled)
    squareCustomerId  String?  // Square customer ID
    squareSubscriptionId String? // Square subscription ID
    cancelledAt       DateTime? // When user cancelled (still valid until subscriptionEndsAt)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    
    @@index([userPubkey])
    @@index([status])
}

enum SubscriptionStatus {
    TRIAL           // In 7 day free trial
    ACTIVE          // Paid and active
    PAST_DUE        // Payment failed, grace period
    CANCELLED       // User cancelled, still valid until end date
    EXPIRED         // Trial or subscription expired
}

enum FeedType {
    RSS
    NOSTR
    NOSTR_VIDEO
}